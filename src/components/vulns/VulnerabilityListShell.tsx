import {useMemo, useState} from "react";
import {List, type RowComponentProps} from "react-window";
import {useNavigate} from "react-router-dom";
import {useAppDispatch, useAppSelector} from "../../store/hooks";
import {addToCompare} from "../../store/slices/compareSlice";
import {
    Alert,
    Box,
    Button,
    Card, CardContent,
    Chip,
    CircularProgress,
    Divider,
    LinearProgress,
    Stack,
    Typography
} from "@mui/material";
import BugReportIcon from "@mui/icons-material/BugReport";
import FilterAltIcon from "@mui/icons-material/FilterAlt";
import ExpandMoreIcon from "@mui/icons-material/ExpandMore";
import CheckCircleIcon from "@mui/icons-material/CheckCircle";

import VulnerabilityRow from "./VulnerabilityRow";
import {useByKaiStatusIndex, useMeta} from "../../data/hooks";
import {useChunkRange} from "../../data/useChunkRange";
import type {VulnerabilityRow as VulnRow} from "../../types/vuln";
import {buildChunkRowSet, type ChunkRowSet, isExcludedRow} from "../../data/kaiIndex";
import {compareRows, matchesFilters} from "../../data/filtering";

type VisibleRef = { chunkNo: number; rowIndex: number };

type RowProps = {
    chunkMap: Map<number, VulnRow[]>;
    visibleRefs: VisibleRef[];
};

function VulnerabilityListRow({
                                  index,
                                  chunkMap,
                                  visibleRefs,
                                  style,
                              }: RowComponentProps<RowProps>) {
    const navigate = useNavigate();
    const dispatch = useAppDispatch();

    const ref = visibleRefs[index];
    const rows = chunkMap.get(ref.chunkNo) ?? [];
    const r = rows[ref.rowIndex];

    if (!r) return null;

    return (
        <div style={style}>
            <VulnerabilityRow
                cve={r.cve}
                severity={String(r.severity)}
                packageName={r.packageName ?? "—"}
                image={r.imageName ?? "—"}
                onOpen={() => navigate(`/vulnerabilities/${encodeURIComponent(r.id)}`)}
                onCompare={() => dispatch(addToCompare(r.id))}
            />
        </div>
    );
}

export default function VulnerabilityListShell() {
    const { data: meta } = useMeta();
    const totalChunks = meta?.totalChunks ?? 1;

    const [loadedCount, setLoadedCount] = useState(1);
    const chunkNos = useMemo(() => Array.from({ length: loadedCount }, (_, i) => i), [loadedCount]);

    const { rowsByChunk, isLoading, isError, error } = useChunkRange(chunkNos);
    const { data: byKaiStatus } = useByKaiStatusIndex();

    const analysis = useAppSelector((s) => s.analysis);
    const filters = useAppSelector((s) => s.filters);

    // kaiStatus lookup maps (memo)
    const manualSet: ChunkRowSet | null = useMemo(() => {
        if (!byKaiStatus) return null;
        return buildChunkRowSet(byKaiStatus["invalid - norisk"]);
    }, [byKaiStatus]);

    const aiSet: ChunkRowSet | null = useMemo(() => {
        if (!byKaiStatus) return null;
        return buildChunkRowSet(byKaiStatus["ai-invalid-norisk"]);
    }, [byKaiStatus]);

    // Build: chunkMap + visibleRefs (after kaiStatus exclusion + normal filters)
    const { chunkMap, visibleRefs, removedByFilters } = useMemo(() => {
        const map = new Map<number, VulnRow[]>();
        const refs: VisibleRef[] = [];

        let kept = 0;
        let scanned = 0;

        // We'll "sort within the loaded set" by collecting refs, then sorting them by row values.
        // This is fine for loaded chunks; for the full dataset you'd do backend/indexed sort.
        const temp: Array<{ ref: VisibleRef; row: VulnRow }> = [];

        for (const entry of rowsByChunk) {
            map.set(entry.chunkNo, entry.rows);

            for (let i = 0; i < entry.rows.length; i++) {
                const row = entry.rows[i];
                scanned++;

                // kaiStatus exclusions
                const excluded = isExcludedRow(
                    entry.chunkNo,
                    i,
                    manualSet,
                    aiSet,
                    analysis.excludeManualNoRisk,
                    analysis.excludeAiNoRisk
                );
                if (excluded) continue;

                // normal filters
                if (!matchesFilters(row, filters)) continue;

                kept++;
                temp.push({ ref: { chunkNo: entry.chunkNo, rowIndex: i }, row });
            }
        }

        // Sort loaded view
        temp.sort((x, y) => compareRows(x.row, y.row, filters.sortKey, filters.sortDir));

        for (const t of temp) refs.push(t.ref);

        return {
            chunkMap: map,
            visibleRefs: refs,
            removedByFilters: scanned - kept,
        };
    }, [
        rowsByChunk,
        manualSet,
        aiSet,
        analysis.excludeManualNoRisk,
        analysis.excludeAiNoRisk,
        filters,
    ]);

    const canLoadMore = loadedCount < totalChunks;
    const loadProgress = totalChunks > 0 ? (loadedCount / totalChunks) * 100 : 0;

    // Loading state
    if (isLoading && rowsByChunk.length === 0) {
        return (
            <Card
                elevation={0}
                sx={{
                    border: '1px solid',
                    borderColor: 'divider',
                    borderRadius: 2,
                    minHeight: 400,
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "center"
                }}
            >
                <Box sx={{ textAlign: 'center', p: 4 }}>
                    <CircularProgress size={40} sx={{ mb: 2 }} />
                    <Typography variant="h6" fontWeight="600" gutterBottom>
                        Loading Vulnerabilities
                    </Typography>
                    <Typography variant="body2" color="text.secondary">
                        Please wait while we fetch the data...
                    </Typography>
                </Box>
            </Card>
        );
    }

    // Error state
    if (isError) {
        return (
            <Card
                elevation={0}
                sx={{
                    border: '1px solid',
                    borderColor: 'error.main',
                    borderRadius: 2,
                    minHeight: 400
                }}
            >
                <CardContent>
                    <Alert severity="error" sx={{ mb: 2 }}>
                        <Typography variant="subtitle1" fontWeight="600">
                            Failed to load vulnerabilities
                        </Typography>
                    </Alert>
                    <Typography variant="body2" color="text.secondary">
                        {error?.message || 'An unexpected error occurred'}
                    </Typography>
                </CardContent>
            </Card>
        );
    }

    // Empty state
    if (visibleRefs.length === 0 && !isLoading) {
        return (
            <Card
                elevation={0}
                sx={{
                    border: '1px solid',
                    borderColor: 'divider',
                    borderRadius: 2,
                    minHeight: 400
                }}
            >
                <Box sx={{ textAlign: 'center', p: 6 }}>
                    <CheckCircleIcon sx={{ fontSize: 64, color: '#388e3c', mb: 2 }} />
                    <Typography variant="h6" fontWeight="600" gutterBottom>
                        No vulnerabilities found
                    </Typography>
                    <Typography variant="body2" color="text.secondary" sx={{ mb: 3 }}>
                        {removedByFilters > 0
                            ? `All ${removedByFilters.toLocaleString()} vulnerabilities were filtered out. Try adjusting your filters.`
                            : 'There are no vulnerabilities matching your current criteria.'
                        }
                    </Typography>
                    {removedByFilters > 0 && (
                        <Chip
                            icon={<FilterAltIcon />}
                            label={`${removedByFilters.toLocaleString()} filtered out`}
                            sx={{
                                bgcolor: '#fff3e0',
                                color: '#f57c00',
                                border: '1px solid #f57c00',
                                fontWeight: 600
                            }}
                        />
                    )}
                </Box>
            </Card>
        );
    }

    return (
        <Card
            elevation={0}
            sx={{
                border: '1px solid',
                borderColor: 'divider',
                borderRadius: 2,
                display: 'flex',
                flexDirection: 'column',
                height: 'calc(100vh - 200px)',
                maxHeight: '900px'
            }}
        >
            {/* Header */}
            <Box sx={{ p: 2 }}>
                <Stack direction="row" justifyContent="space-between" alignItems="center" mb={1.5}>
                    <Box display="flex" alignItems="center" gap={1.5}>
                        <BugReportIcon color="primary" />
                        <Typography variant="h6" fontWeight="600">
                            Vulnerabilities
                        </Typography>
                        <Chip
                            size="small"
                            label={visibleRefs.length.toLocaleString()}
                            sx={{
                                bgcolor: '#1976d2',
                                color: '#fff',
                                fontWeight: 700,
                            }}
                        />
                    </Box>

                    {removedByFilters > 0 && (
                        <Chip
                            size="small"
                            icon={<FilterAltIcon sx={{ fontSize: 14 }} />}
                            label={`${removedByFilters.toLocaleString()} filtered`}
                            sx={{
                                bgcolor: '#fff3e0',
                                color: '#f57c00',
                                border: '1px solid #f57c00',
                                fontWeight: 600
                            }}
                        />
                    )}
                </Stack>

                {/* Load progress */}
                {canLoadMore && (
                    <Box sx={{ mb: 1 }}>
                        <Box display="flex" justifyContent="space-between" alignItems="center" mb={0.5}>
                            <Typography variant="caption" color="text.secondary">
                                Loaded {loadedCount} of {totalChunks} chunks
                            </Typography>
                            <Typography variant="caption" fontWeight="600" color="primary">
                                {loadProgress.toFixed(0)}%
                            </Typography>
                        </Box>
                        <LinearProgress
                            variant="determinate"
                            value={loadProgress}
                            sx={{
                                height: 6,
                                borderRadius: 1,
                                bgcolor: '#e0e0e0',
                                '& .MuiLinearProgress-bar': {
                                    borderRadius: 1,
                                }
                            }}
                        />
                    </Box>
                )}
            </Box>

            <Divider />

            {/* List */}
            <Box sx={{ flex: 1, overflow: 'hidden' }}>
                {isLoading && rowsByChunk.length > 0 ? (
                    <Box sx={{ p: 2 }}>
                        <LinearProgress />
                    </Box>
                ) : null}

                <List
                    rowComponent={VulnerabilityListRow}
                    rowCount={visibleRefs.length}
                    rowHeight={74}
                    rowProps={{ chunkMap, visibleRefs }}
                />
            </Box>

            {/* Footer - Load More */}
            {canLoadMore && (
                <>
                    <Divider />
                    <Box sx={{ p: 2, textAlign: 'center' }}>
                        <Button
                            variant="outlined"
                            size="large"
                            endIcon={<ExpandMoreIcon />}
                            disabled={!canLoadMore || isLoading}
                            onClick={() => setLoadedCount((c) => Math.min(totalChunks, c + 1))}
                            sx={{
                                borderRadius: 2,
                                px: 4,
                                fontWeight: 600,
                                borderColor: 'divider',
                                '&:hover': {
                                    borderColor: 'primary.main',
                                    bgcolor: 'action.hover',
                                }
                            }}
                        >
                            {isLoading ? 'Loading...' : 'Load More Vulnerabilities'}
                        </Button>
                        <Typography variant="caption" color="text.secondary" display="block" sx={{ mt: 1 }}>
                            {totalChunks - loadedCount} more chunks available
                        </Typography>
                    </Box>
                </>
            )}

            {/* Footer - All Loaded */}
            {!canLoadMore && visibleRefs.length > 0 && (
                <>
                    <Divider />
                    <Box
                        sx={{
                            p: 2,
                            textAlign: 'center',
                            bgcolor: '#e8f5e9'
                        }}
                    >
                        <Box display="flex" alignItems="center" justifyContent="center" gap={1}>
                            <CheckCircleIcon sx={{ fontSize: 18, color: '#388e3c' }} />
                            <Typography variant="body2" fontWeight="600" color="#388e3c">
                                All vulnerabilities loaded ({visibleRefs.length.toLocaleString()} total)
                            </Typography>
                        </Box>
                    </Box>
                </>
            )}
        </Card>
    );
}
