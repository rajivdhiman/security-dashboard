import {useNavigate, useParams} from "react-router-dom";
import {Box, Breadcrumbs, Button, Card, CardContent, Link, Skeleton, Stack, Typography} from "@mui/material";
import ArrowBackIcon from "@mui/icons-material/ArrowBack";
import ErrorOutlineIcon from "@mui/icons-material/ErrorOutline";
import HomeIcon from "@mui/icons-material/Home";
import NavigateNextIcon from "@mui/icons-material/NavigateNext";

import VulnHeader from "../components/vuln-detail/VulnHeader";
import VulnFacts from "../components/vuln-detail/VulnFacts";
import RiskFactorsPanel from "../components/vuln-detail/RiskFactorsPanel";
import DescriptionPanel from "../components/vuln-detail/DescriptionPanel";
import TimelinePanel from "../components/vuln-detail/TimelinePanel";
import VulnActions from "../components/vuln-detail/VulnActions";
import {useVulnById} from "../data/useVulnById";

import {useAppDispatch} from "../store/hooks";
import {addToCompare} from "../store/slices/compareSlice";
import {exportRowCsv, exportRowJson} from "../utils/exportOne";

function LoadingState() {
    return (
        <Stack spacing={3}>
            {/* Header Loading */}
            <Box>
                <Skeleton width={80} height={28} sx={{ mb: 2 }} />
                <Card elevation={0} sx={{ border: '1px solid', borderColor: 'divider', borderRadius: 2 }}>
                    <CardContent>
                        <Skeleton width="60%" height={40} sx={{ mb: 2 }} />
                        <Box display="flex" gap={2}>
                            <Skeleton width={120} height={32} />
                            <Skeleton width={100} height={32} />
                        </Box>
                    </CardContent>
                </Card>
            </Box>

            {/* Actions Loading */}
            <Box display="flex" gap={2}>
                <Skeleton variant="rectangular" width={140} height={40} sx={{ borderRadius: 1 }} />
                <Skeleton variant="rectangular" width={120} height={40} sx={{ borderRadius: 1 }} />
                <Skeleton variant="rectangular" width={120} height={40} sx={{ borderRadius: 1 }} />
            </Box>

            {/* Content Loading */}
            {[1, 2, 3, 4].map((i) => (
                <Card key={i} elevation={0} sx={{ border: '1px solid', borderColor: 'divider', borderRadius: 2 }}>
                    <CardContent>
                        <Skeleton width="40%" height={32} sx={{ mb: 2 }} />
                        <Skeleton width="100%" height={20} sx={{ mb: 1 }} />
                        <Skeleton width="90%" height={20} sx={{ mb: 1 }} />
                        <Skeleton width="95%" height={20} />
                    </CardContent>
                </Card>
            ))}
        </Stack>
    );
}

function ErrorState({
                        title,
                        message,
                        onBack
                    }: {
    title: string;
    message: string;
    onBack: () => void;
}) {
    return (
        <Box>
            <Button
                startIcon={<ArrowBackIcon />}
                onClick={onBack}
                sx={{ mb: 3, fontWeight: 600 }}
            >
                Back to Vulnerabilities
            </Button>

            <Card
                elevation={0}
                sx={{
                    border: '1px solid',
                    borderColor: 'divider',
                    borderRadius: 2
                }}
            >
                <CardContent>
                    <Box sx={{ textAlign: 'center', py: 6 }}>
                        <ErrorOutlineIcon
                            sx={{
                                fontSize: 80,
                                color: '#d32f2f',
                                mb: 2
                            }}
                        />
                        <Typography variant="h5" fontWeight="600" gutterBottom>
                            {title}
                        </Typography>
                        <Typography variant="body1" color="text.secondary" sx={{ maxWidth: 600, mx: 'auto', mb: 3 }}>
                            {message}
                        </Typography>
                        <Button
                            variant="contained"
                            onClick={onBack}
                            sx={{
                                borderRadius: 2,
                                fontWeight: 600,
                                px: 4
                            }}
                        >
                            Go to Vulnerabilities
                        </Button>
                    </Box>
                </CardContent>
            </Card>
        </Box>
    );
}

export default function VulnerabilityDetailPage() {
    const { id } = useParams();
    const navigate = useNavigate();
    const dispatch = useAppDispatch();

    const { row, isLoading, isError } = useVulnById(id);

    const handleBack = () => {
        navigate("/vulnerabilities");
    };

    // Loading State
    if (isLoading) {
        return (
            <Box>
                <Button
                    startIcon={<ArrowBackIcon />}
                    onClick={handleBack}
                    sx={{ mb: 3, fontWeight: 600 }}
                >
                    Back to Vulnerabilities
                </Button>
                <LoadingState />
            </Box>
        );
    }

    // Error State
    if (isError || !row) {
        return (
            <ErrorState
                title="Vulnerability Not Found"
                message="The vulnerability ID does not exist in the dataset or the data could not be loaded. Please check the ID and try again, or return to the vulnerabilities list."
                onBack={handleBack}
            />
        );
    }

    return (
        <Box>
            {/* Breadcrumbs Navigation */}
            <Box mb={3}>
                <Breadcrumbs
                    separator={<NavigateNextIcon fontSize="small" />}
                    sx={{ mb: 2 }}
                >
                    <Link
                        component="button"
                        onClick={() => navigate("/")}
                        sx={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: 0.5,
                            color: 'text.secondary',
                            textDecoration: 'none',
                            fontWeight: 500,
                            fontSize: '0.875rem',
                            '&:hover': {
                                color: 'primary.main',
                                textDecoration: 'underline'
                            }
                        }}
                    >
                        <HomeIcon sx={{ fontSize: 16 }} />
                        Dashboard
                    </Link>
                    <Link
                        component="button"
                        onClick={handleBack}
                        sx={{
                            color: 'text.secondary',
                            textDecoration: 'none',
                            fontWeight: 500,
                            fontSize: '0.875rem',
                            '&:hover': {
                                color: 'primary.main',
                                textDecoration: 'underline'
                            }
                        }}
                    >
                        Vulnerabilities
                    </Link>
                    <Typography
                        sx={{
                            fontWeight: 600,
                            fontSize: '0.875rem',
                            color: 'text.primary'
                        }}
                    >
                        {row.cve}
                    </Typography>
                </Breadcrumbs>

                <Button
                    startIcon={<ArrowBackIcon />}
                    onClick={handleBack}
                    sx={{
                        fontWeight: 600,
                        color: 'text.secondary',
                        '&:hover': {
                            color: 'primary.main',
                            bgcolor: 'transparent'
                        }
                    }}
                >
                    Back to Vulnerabilities
                </Button>
            </Box>

            {/* Main Content */}
            <Stack spacing={3}>
                <VulnHeader cve={row.cve} severity={String(row.severity)} cvss={row.cvss} />

                <VulnActions
                    onAddToCompare={() => {
                        dispatch(addToCompare(row.id));
                        navigate("/compare");
                    }}
                    onExportJson={() => exportRowJson(row)}
                    onExportCsv={() => exportRowCsv(row)}
                />

                <VulnFacts row={row} />
                <DescriptionPanel row={row} />
                <RiskFactorsPanel row={row} />
                <TimelinePanel row={row} />
            </Stack>
        </Box>
    );
}
